<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
    <script type="text/javascript" src="js/process.js" ></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
    <script type="text/javascript" src="js/process.js" ></script>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

    <script src="https://cdn.rawgit.com/seikichi/tiff.js/master/tiff.min.js"></script>

    <script src="https://cdn.rawgit.com/rfvallina/Misc/master/pdf.js"></script>

    <script type="text/javascript"><!--


    // --></script>
    <style>
        #send { display:block; margin:1em auto; background:#fff; border:1px solid #ccc }
    </style>
</head>

<body>
    <!--[if lt IE 8]>
                   <![endif]-->
    <nav class="navbar navbar-default ">
        <div class="container bg-1">
            <div class="navbar-header bg-1"> <a class="navbar-brand" href="#">Histogram Image Density</a> </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="../index.html">Back</a></li>



                </ul>

            </div>
        </div>
    </nav>
    <div class="container text-right">
        <div class="container-fluid main">

            <label class="fileContainer right">
                <br>
                <button type="button" class="btn btn-default">Click here to Upload!</button>
                <input type="file" name="file" id="file" class="inputfile" data-multiple-caption="{count} files selected" multiple />
            </label>
            <div class="row">
                <div class="col-sm-6">

                        <h3 class="text-center">Viewer</h3>

                    <div id="maincontent">

                        <!--<div id="output" height="600px" width="200px" style="background-color: #8f231e;z-index: 14">asdfasdf</div> -->

                    </div>
                   <!-- <p><a><img
                        id="myImg" src="mushroom_kingdom.jpg" width="300" alt=""></a></p>-->
                    <div id="status"></div>

                </div>

                <div class="col-sm-6  ">
                    <div class="control">
                        <h3 class="text-center">Controls</h3>
                        <div class="tab-content">
                            <ul class="nav nav-tabs">
                                <li id="first" class="nav active"><a href="#A" onclick="changer(1)" data-toggle="tab">RGB Band</a></li>
                                <li class="nav"><a href="#A" onclick="changer(2)" data-toggle="tab">Red Band</a></li>

                                <li class="nav"><a href="#A" onclick="changer(4)" data-toggle="tab">Green Band</a></li>
                                <li class="nav"><a href="#A" onclick="changer(3)" data-toggle="tab">Blue Band</a></li>
                                <li class="nav"><a href="#E" data-toggle="tab">Option</a></li>
                            </ul>

                            <!-- Tab panes -->
                            <div class="tab-content text-center">

                                <div class="tab-pane fade in active" id="A"><canvas class="thumb" id="histogram" width="640" height="380">Your
                                    browser does not have support for Canvas.</canvas>

                                    <div id="range">

                                        <input type="range" id="myRangestart" class="center"  value="0" min="0" max="255" onchange="updateTextInput(this.value);">
                                        <div class="row">
                                            <div class="col-sm-6 text-left" ><kbd>0</kbd> </div>
                                            <div class="col-sm-6 text-right"> <kbd>255</kbd>   </div>
                                        </div>
                                        <input type="range" id="myRangeend" class="center"  value="255" min="0" max="255" onchange="updateTextInputd(this.value);">
                                        <div class="row">
                                            <div class="col-sm-6 text-left" ><kbd>0</kbd> </div>
                                            <div class="col-sm-6 text-right"> <kbd>255</kbd>   </div>
                                        </div>

                                    </div>
                                    <ul id="cal">

                                    </ul>


                                    <p id="runtime">Plot runtime...</p></div>
                                <div class="tab-pane fade text-center" id="E">

                                    <form class="form-inline">




                                        <select id="histType" hidden>
                                            <option value="rgb">RGB</option>
                                            <option value="red">Red</option>
                                            <option value="green">Green</option>
                                            <option value="blue">Blue</option>
                                            <option value="hue">Hue</option>
                                            <option value="sat">Saturation</option>
                                            <option value="val">Value (brightness)</option>
                                            <option value="cmyk">CMYK</option>
                                            <option value="cyan">Cyan</option>
                                            <option value="magenta">Magenta</option>
                                            <option value="yellow">Yellow</option>
                                            <option value="kelvin">Kelvin (Black)</option>
                                        </select>

                                       <br>

                                    <div class="form-group">
                                        <p><label>Count every <input class="form-control" id="accuracy" type="number" min="1" max="50"
                                                                     value="1"> pixels</label></p>
                                    </div>
                                        <hr>
                                    <p><label>Plot style: <select class="form-control" id="plotStyle">
                                        <option value="continuous">Continuous</option>
                                        <option value="discreet">Discreet</option>
                                    </select></label></p>
                                        <hr>
                                    <p><label>Plot fill <input class="form-control" id="plotFill" type="checkbox"></label></p>
                                        <hr>
                                    <p hidden><label>Plot colors: <select id="plotColors" class="form-control">
                                        <option value="flat">Flat colors</option>
                                        <option value="none">None</option>

                                        <option value="gradient">Gradients</option>
                                    </select></label></p>

                                    </form>
                                    <a onclick="linear_stretch()" class="btn btn-default">Linear</a>
                                    <hr>
                                    <a onclick=" root_stretch()" class="btn btn-default">Log Stretch</a>
                                    <a onclick=" histogram_equilization()" class="btn btn-default">Histogram Equilization</a>
                                    <hr>
                                    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#myModal">Zoom</button>
                                    <hr>

                                    <a onclick=" root_stretch()" class="btn btn-default">Log Stretch</a>


                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div class="modal fade" id="bandmodal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Choose your coresponding Bands</h4>
                </div>
                <div class="modal-body">

                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="row">
                                <div class="col-sm-6"><h4>Band 1 :</h4>

                                </div>
                                <div class="col-sm-6">

                                    <select id="one">
                                        <option selected>One</option>
                                        <option >Two</option>
                                        <option>Three</option>

                                    </select>

                                </div>
                            </div>

                        </li>
                        <li class="list-group-item"> <div class="row">
                            <div class="col-sm-6"><h4>Band 2 :</h4>

                            </div>
                            <div class="col-sm-6">

                                <select id="two">
                                    <option >One</option>
                                    <option selected>Two</option>
                                    <option>Three</option>

                                </select>

                            </div>
                        </div></li>
                        <li class="list-group-item"> <div class="row">
                            <div class="col-sm-6"><h4>Band 3 :</h4>
                            </div>
                            <div class="col-sm-6">

                                <select id="three">
                                    <option >One</option>
                                    <option >Two</option>
                                    <option selected>Three</option>

                                </select>
                            </div>
                        </div></li>
                    </ul>


                    <div class="row">
                        <div class="col-sm-12">
                            <div class="text-center">
                                <button onclick="loadImage()" type="button center-block" class="btn btn-success">Load Image</button>
                            </div>
                        </div>
                    </div>



                </div>

            </div>
        </div>
    </div>


    <!-- Modal -->
    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Zoom View</h4>
                </div>
                <div class="modal-body">
                    <canvas id="popupzoom"></canvas>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>
    <br>
    <hr>
    <div class="row"> <span class="center-block text-center">Done Editing? <a href="#" id="down" class="btn btn-success" role="button">Download Image</a></span> </div>
    <br>
        <footer class="text-center navbar navbar-default ">

        </footer>
    <!-- /container -->

    <script>
        function overlay(){

            el = document.getElementById("overlay");
            el.style.visibility = (el.style.visibility == "visible") ? "hidden" : "visible";

        }

        function close() {
            document.getElementById("overlay").style.visibility = 'hidden';
        }

        window.urlf;
        $('#myModal').on('shown.bs.modal', function (e) {
            // do something...
            // alert("opweaw");
            zoom();

        });
        document.getElementById('down').addEventListener('click', function() {
            downloadCanvas(this, 'c', 'test.png');
        }, false);
        function downloadCanvas(link, canvasId, filename) {

            link.href = document.getElementById(canvasId).toDataURL();
            link.download = filename;
        }
        function calmean(pixel, n, m) {
            "use strict";
            var i, j, mean = 0;
            for (i = 0; i < n; i += 1) {
                for (j = 0; j < m; j += 1) {
                    mean += pixel[i][j];
                }
            }
            mean = mean / (n * m);
            return mean;
        }

        function calvariance(pixel, n, m) {
            "use strict";
            var i, j, variance, sum = 0, mean = calmean(pixel, n, m);
            for (i = 0; i < n; i += 1) {
                for (j = 0; j < m; j += 1) {
                    sum += Math.pow(mean - pixel[i][j]);
                }
            }
            variance = sum / ((n * m) - 1);
            return variance;
        }

        function calstddevi(pixel, n, m) {
            "use strict";
            var stddevi = Math.sqrt(calvariance(pixel, n, m));
            return stddevi;
        }
        document.getElementById('maincontent').innerHTML += "<canvas style=\"z-index: -10;\" id=\"c\" ></canvas> ";
        var ctx = c.getContext("2d");

        var k=0;
        var original;
        var stack = [];
        newImage("http://i.imgur.com/OrYVGI8.jpg");

        window.canvas;
        $("#file").change(function(evt){
            var parentEl = $("#maincontent");
            $('#bandmodal').modal('show');
            console.debug("Event image...");
            var tgt = evt.target || window.event.srcElement,
                files = tgt.files;
            var extensions = files[0].name.split('.').pop().toLowerCase();
            console.debug(extensions);
            if (extensions != "tiff" && extensions != "tif"){
                var URL = window.webkitURL || window.URL;
                var url = URL.createObjectURL(evt.target.files[0]);
                window.urlf=url;
                newImage(url);

                histType.value="rgb";
                updateHist("rgb");

            }
            else {
                var fileTypes = ['jpg', 'jpeg', 'png', 'tiff', 'tif', 'pdf'];
                var URL = window.webkitURL || window.URL;
                var url = URL.createObjectURL(evt.target.files[0]);
                window.urlf=url;
                parentEl.find("canvas").remove();
                if (FileReader && files && files.length) {
                    var fr = new FileReader();
                    var extension = files[0].name.split('.').pop().toLowerCase();
                    var tif = false;
                    var pdf = false;
                    if (extension == "tiff" || extension == "tif")
                        tif = true;
                    else if (extension == "pdf")
                        pdf = true;
                    fr.onload = function(e) {
                        success = fileTypes.indexOf(extension) > -1;
                        if (success) {
                            if (tif) {
                                window.urlf="tiff";
                                //Using tiff.min.js library - https://github.com/seikichi/tiff.js/tree/master
                                console.debug("Parsing TIFF image...");
                                //initialize with 100MB for large files
                                Tiff.initialize({
                                    TOTAL_MEMORY: 100000000
                                });
                                var tiff = new Tiff({
                                    buffer: e.target.result
                                });
                                var tiffCanvas = tiff.toCanvas();
                                window.canvas=tiffCanvas;
                                tiffCanvas.toBlob(function(blob) {
                                    saveAs(blob, "pretty image.png");
                                });
                                $(tiffCanvas).css({

                                    "z-index":"-10",
                                    "max-width" :"100%",
                                    "max-height" :"100%"
                                });
                                tiffCanvas.id="c";
                                console.debug("converted");
                                $(parentEl).append(tiffCanvas);
                                ctx=tiffCanvas.getContext("2d");
                                $('#c').mousemove(function(e) {
                                    console.log("here ");
                                    var pos = findPos(this);
                                    var x = e.pageX - pos.x;
                                    var y = e.pageY - pos.y;
                                    var coord = "x=" + x + ", y=" + y;
                                    var c1 = this.getContext('2d');
                                    var p = c1.getImageData(x, y, 1, 1).data;
                                    //var hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
                                    //$('#status').html(coord + "<br>" + hex);
                                    $('#status').html(coord + "<br>" +"<p style=\"color:red;display:inline\">R: "+" "+ p[0]+"</p><p style=\"color:green;display:inline\">  G: "+p[1]+"</p> <p style=\"color:blue;display:inline\">  B: "+p[2]+"</p>");
                                });
                                runner(ctx);
                            } else if (pdf) {

                            } else {
                                console.debug("render immmm");
                                $(parentEl).append('<img src="' + fr.result + '" class="preview"/>');
                            }
                        }

                    }

                    fr.onloadend = function(e) {
                        console.debug("Load End");
                    }
                    if (tif)
                        fr.readAsArrayBuffer(files[0]);

                }
            }
        });

        var acc = document.getElementsByClassName("accordion");
        var i;

        for (i = 0; i < acc.length; i++) {
            acc[i].onclick = function(){
                this.classList.toggle("active");
                this.nextElementSibling.classList.toggle("show");
            }
        }


        var histCanvas = document.getElementById('histogram'),
            histCtx = histCanvas.getContext('2d'),
            histType = document.getElementById('histType'),
            accuracy = document.getElementById('accuracy'),

            plotStyle = document.getElementById('plotStyle'),
            calc = document.getElementById('cal'),
            plotFill = document.getElementById('plotFill'),

            plotColors = document.getElementById('plotColors'),
            imgSelector = document.getElementById('imgSelector'),
            gradients = {
                'red':     histCtx.createLinearGradient(0, 0, 500, 0),
                'green':   histCtx.createLinearGradient(0, 0, 500, 0),
                'blue':    histCtx.createLinearGradient(0, 0, 500, 0),
                'hue':     histCtx.createLinearGradient(0, 0, 500, 0),
                'val':     histCtx.createLinearGradient(0, 0, 500, 0),
                'cyan':    histCtx.createLinearGradient(0, 0, 500, 0),
                'magenta': histCtx.createLinearGradient(0, 0, 500, 0),
                'yellow':  histCtx.createLinearGradient(0, 0, 500, 0),
                'kelvin':  histCtx.createLinearGradient(0, 0, 500, 0)
            },

            imgCtx = ctx,
            colors = {
                'red':   ['#000', '#f00'],
                'green': ['#000', '#0f0'],
                'blue':  ['#000', '#00f'],
                'hue':   [
                    '#f00',   // 0, Red,       0°
                    '#ff0',   // 1, Yellow,   60°
                    '#0f0',   // 2, Green,   120°
                    '#0ff',   // 3, Cyan,    180°
                    '#00f',   // 4, Blue,    240°
                    '#f0f',   // 5, Magenta, 300°
                    '#f00'],  // 6, Red,     360°
                'val':     ['#000', '#fff'],
                'kelvin':  ['#fff', '#000'],
                'cyan':    ['#000', '#0ff'],
                'yellow':  ['#000', '#ff0'],
                'magenta': ['#000', '#f0f']
            },
            discreetWidth = Math.round(histCanvas.width / 255),
            imgData = null;
           plotFill.checked=true;
        var initHistogram = function () {
            // Plot defaults
            accuracy.value = 1;
            plotStyle.value = 'continuous';
            plotColors.value = 'flat';
            plotFill.checked = true;


            console.log(imgData);
            var grad, color, i, n;
            for (grad in gradients) {
                color = colors[grad];
                grad = gradients[grad];

                for (i = 0, n = color.length; i < n; i++) {
                    grad.addColorStop(i*1/(n-1), color[i]);
                }
            }

        };
        var imgLoaded = function (t) {
            imgData = original.data;

            histType.value = t;

            //updateHist();
        };
        var chans = [[]];
        var calcHist = function (type) {
            var mean; var redavg=0,blueavg=0,greenavg=0; var tt=0;
            chans = [[]];
                var maxCount = 0, val, subtypes = [type];

            if (type === 'rgb') {
                chans = [[], [], []];
                subtypes = ['red', 'green', 'blue'];
            }

            var step = parseInt(accuracy.value);
            if (isNaN(step) || step < 1) {
                step = 1;
            } else if (step > 50) {
                step = 50;
            }
            accuracy.value = step;
            step *= 4;

            for (var i = 0, n = imgData.length; i < n; i+= step) {
                if (type === 'rgb' || type === 'red' || type === 'green' || type ===
                    'blue') {
                    val = [imgData[i], imgData[i+1], imgData[i+2]];

                }
                if(type==='rgb'){
                    redavg+=imgData[i];
                    blueavg+=imgData[i+1];
                    greenavg+=imgData[i+2];
                }
                else if(type ==='red'){
                    redavg+=imgData[i];
                }
                else if(type==='green'){
                    blueavg+=imgData[i+1];
                }
                else if(type==='blue'){
                    greenavg+=imgData[i+2];
                }

                if (type === 'red' || type === 'hue' || type === 'cyan') {

                    val = [val[0]];

                } else if (type === 'green' || type === 'sat' || type === 'magenta') {

                    val = [val[1]];

                } else if (type === 'blue' || type === 'val' || type === 'yellow') {

                    val = [val[2]];

                } else if (type === 'kelvin') {
                    val = [val[3]];
                }

                for (var y = 0, m = val.length; y < m; y++) {
                    if (val[y] in chans[y]) {
                        chans[y][val[y]]++;
                    } else {
                        chans[y][val[y]] = 1;
                    }

                    if (chans[y][val[y]] > maxCount) {
                        maxCount = chans[y][val[y]];
                    }
                }
            }


            tt=redavg+blueavg+greenavg;
            var pix=imgData.length/4;
            tt=tt/pix;
            i=0; var vari=0;
            for (var i = 0, n = imgData.length; i < n; i+= step) {
                if(type==='rgb'){
                    var tmp=tt-(imgData[i]+imgData[i+1]+imgData[i+2])/3;
                }
                else if(type ==='red'){
                    var tmp=tt-(imgData[i]);
                }
                else if(type==='green'){
                    var tmp=tt-(imgData[i+1]);
                }
                else if(type==='blue'){
                    var tmp=tt-(imgData[i+2]);
                }
                //console.log(tmp);
                vari += Math.pow(tmp, 2);
            }
            vari = vari/pix;
            var stdev=Math.sqrt(vari);
            /*for (var i = 0, n = imgData.length; i < n; i+= step) {
                if (type === 'rgb') {
                    redavg += imgData[i];
                    blueavg += imgData[i + 1];
                    greenavg += imgData[i + 2];
                }
                else if (type === 'red') {
                    redavg += imgData[i];
                }
                else if (type === 'green') {
                    blueavg += imgData[i + 1];
                }
                else if (type === 'blue') {
                    greenavg += imgData[i + 2];
                }
            }*/
            if(type==='rgb'){
                tt=tt/3;
                $("#range").hide();

            }
            else{
                $("#range").show();
            }
            tt=tt.toFixed(2);
            document.getElementById("cal").innerHTML="";
           // document.getElementById("cal").removeChild("All")
            var node = document.createElement("LI");
            var textnode = document.createTextNode("Mean : "+tt);
            var textnode3 = document.createTextNode("Standard Deviation : "+stdev.toFixed(2));

            var textnode1 = document.createTextNode("Pixels : "+pix);
            var textnode2 = document.createTextNode("RGB Avg : "+redavg+" | "+greenavg+" | "+blueavg);

            node.appendChild(textnode);
            document.getElementById("cal").appendChild(node);
            node = document.createElement("LI");
            node.appendChild(textnode3);
            document.getElementById("cal").appendChild(node);
            node = document.createElement("LI");
            node.appendChild(textnode1);
            document.getElementById("cal").appendChild(node);
            node = document.createElement("LI");
            node.appendChild(textnode2);
            document.getElementById("cal").appendChild(node);
          //  calc.innerHTML = 'Mean : '+tt+" \n Red :"+redavg+" Blue:"+blueavg+" Green: "+greenavg+" Pixels : "+imgData.length/4;
            console.log(tt+" "+tt/imgData.length/4+" "+imgData.length/4);
            if (maxCount === 0) {
                return;
            }

            histCtx.clearRect(0, 0, histCanvas.width, histCanvas.height);

            if (plotFill.checked && chans.length > 1) {
                histCtx.globalCompositeOperation = 'lighter';
            }

            for (var i = 0, n = chans.length; i < n; i++) {
                drawHist(subtypes[i], chans[i], maxCount);
            }

            if (plotFill.checked && chans.length > 1) {
                histCtx.globalCompositeOperation = 'source-over';
            }
        };
        var drawHist = function (type, vals, maxCount) {
            var ctxStyle;

            if (plotFill.checked || plotStyle.value === 'discreet') {
                ctxStyle = 'fillStyle';
                histCtx.strokeStyle = '#000';
            } else {
                ctxStyle = 'strokeStyle';
            }

            if (plotColors.value === 'flat') {
                if (type === 'hue') {
                    histCtx[ctxStyle] = gradients.hue;
                } else if (type in colors && type !== 'val') {
                    histCtx[ctxStyle] = colors[type][1];
                } else {
                    histCtx[ctxStyle] = '#000';
                }

            } else if (plotColors.value === 'gradient') {
                if (type in gradients) {
                    histCtx[ctxStyle] = gradients[type];
                } else {
                    histCtx[ctxStyle] = '#000';
                }
            } else if (plotColors.value === 'none') {
                histCtx[ctxStyle] = '#000';
            }

            if (plotStyle.value === 'continuous') {
                histCtx.beginPath();
                histCtx.moveTo(0, histCanvas.height);
            }
            var last; var first; var flag=0;
            for (var x, y, i = 0; i <= 255; i++) {
                if (!(i in vals)) {
                    continue;
                }
                if(flag==0){
                    first=i;
                    flag=1;
                }
                last=i;

                y = Math.round((vals[i]/maxCount)*histCanvas.height);
                x = Math.round((i/255)*histCanvas.width);

                if (plotStyle.value === 'continuous') {
                    histCtx.lineTo(x, histCanvas.height - y);
                } else if (plotStyle.value === 'discreet') {
                    if (plotFill.checked) {
                        histCtx.fillRect(x, histCanvas.height - y, discreetWidth, y);
                    } else {
                        histCtx.fillRect(x, histCanvas.height - y, discreetWidth, 2);
                    }
                }
            }
         /*   var median=(first+last)/2;
            var node = document.createElement("LI");
            var textnode = document.createTextNode("Median : "+median);
            node.appendChild(textnode);
            document.getElementById("cal").appendChild(node);*/

            if (plotStyle.value === 'continuous') {
                histCtx.lineTo(x, histCanvas.height);
                if (plotFill.checked) {
                    histCtx.fill();
                }
                histCtx.stroke();
                histCtx.closePath();
            }
        };
        var updateHist = function (tmp) {
           // initHistogram(tmp);
            imgLoaded(tmp);
            var timeStart = (new Date()).getTime();

            runtime.innerHTML = 'Calculating histogram...';

            calcHist(tmp);
            console.log("Here "+histType.value);
            var timeEnd = (new Date()).getTime();
            runtime.innerHTML = 'Plot runtime: ' + (timeEnd - timeStart) + ' ms.';
        };
        var updateHists = function () {
            var timeStart = (new Date()).getTime();

            runtime.innerHTML = 'Calculating histogram...';

            calcHist(histType.value);

            var timeEnd = (new Date()).getTime();
            runtime.innerHTML = 'Plot runtime: ' + (timeEnd - timeStart) + ' ms.';
        };

        function calcu() {
            imgData = original.data;
            var mean; var redavg=0,blueavg=0,greenavg=0;
            var step=4;
            for (var i = 0, n = imgData.length; i < n; i+= step) {
                if (type === 'rgb' || type === 'red' || type === 'green' || type ===
                    'blue') {
                    val = [imgData[i], imgData[i + 1], imgData[i + 2]];
                    redavg+=val[0];
                    blueavg+=val[1];
                }
            }
        }
        plotStyle.addEventListener('change', updateHists, false);
        plotFill.addEventListener('change', updateHists, false);
        plotColors.addEventListener('change', updateHists, false);
        accuracy.addEventListener('change', updateHists, false);

        var red1=0,red2=255,blue1=0,blue2=255,green1=0,green2=255;

        function changer(t){
            if(t==1){
                histType.value="rgb";
                updateHist("rgb");
            }
            if(t==2){
                histType.value="red";

                updateHist("red");
                console.log("hellored");
                console.log(red1);
                console.log(red2);
                var input=document.getElementById("myRangestart");
                input.value=red1;
                input=document.getElementById("myRangeend");
                input.value=red2;

                // histo.
            }
            else if(t==3){
                histType.value="blue";
                updateHist("blue");
                var input=document.getElementById("myRangestart");
                input.value=blue1;
                input=document.getElementById("myRangeend");
                input.value=blue2;                // histo.updateHist();
            }
            else if(t==4){
                histType.value="green";
                updateHist("green");
                var input=document.getElementById("myRangestart");
                input.value=green1;
                input=document.getElementById("myRangeend");
                input.value=green2;                // histo.updateHist();
            }
        }window.onload = function() {
            histType.value="rgb";
            updateHist("rgb");
        };
        function findPos(obj) {
            var curleft = 0, curtop = 0;
            if (obj.offsetParent) {
                do {
                    curleft += obj.offsetLeft;
                    curtop += obj.offsetTop;
                } while (obj = obj.offsetParent);
                return { x: curleft, y: curtop };
            }
            return undefined;
        }



        // set up some squares
        //var example = document.getElementById('example');
        //var context = example.getContext('2d');
        //context.fillStyle = "rgb(255,0,0)";
        //context.fillRect(0, 0, 50, 50);
        //context.fillStyle = "rgb(0,0,255)";
        //context.fillRect(55, 0, 50, 50);

        $('#c').mousemove(function(e) {
            console.log("here ");
            var pos = findPos(this);
            var x = e.pageX - pos.x;
            var y = e.pageY - pos.y;
            var coord = "x=" + x + ", y=" + y;
            var c1 = this.getContext('2d');
            var p = c1.getImageData(x, y, 1, 1).data;
            //var hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
            //$('#status').html(coord + "<br>" + hex);
            $('#status').html(coord + "<br>" +"<p style=\"color:red;display:inline\">R: "+" "+ p[0]+"</p><p style=\"color:green;display:inline\">  G: "+p[1]+"</p> <p style=\"color:blue;display:inline\">  B: "+p[2]+"</p>");
        });



        function zoom() {
            var gkhead = new Image;

            var canvas = document.getElementById("popupzoom");
            canvas.width = 800;
            canvas.height = 600;
            var ctx = canvas.getContext('2d');
            var starter = function () {


                trackTransforms(ctx);

                function redraw() {
                    // Clear the entire canvas
                    //var originals=ctx.getImageData(0, 0, canvas.width, canvas.height);
                    var p1 = ctx.transformedPoint(0, 0);
                    var p2 = ctx.transformedPoint(canvas.width, canvas.height);
                    ctx.clearRect(p1.x, p1.y, p2.x - p1.x, p2.y - p1.y);
                    // alert("asdasd");
                    ctx.save();
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                    ctx.clearRect(0, 0, c.width, c.height);
                    ctx.restore();
                    //console.log(original.data);
                    // ctx.fillRect(0,0,100,100);
                    //newImage(url);
                    gkhead.src = window.urlf;


                    if(window.urlf=="tiff"){
                        ctx.drawImage(window.canvas, 0, 0);
                    }
                    else
                        ctx.drawImage(c, 0, 0);
                    //var myImageData = ctx.createImageData(original.data);
                    console.log(window.urlf);
                    //ctx.drawImage(gkhead, 0, 0);
                    //

                    //ctx.drawImage(window.urlf, 0, 0);
                    //ctx.putImageData(window.canvas, 0, 0);
                }

                redraw();

                var lastX = c.width / 2, lastY = c.height / 2;

                var dragStart, dragged;

                canvas.addEventListener('mousedown', function (evt) {
                    document.body.style.mozUserSelect = document.body.style.webkitUserSelect = document.body.style.userSelect = 'none';
                    lastX = evt.offsetX || (evt.pageX - c.offsetLeft);
                    lastY = evt.offsetY || (evt.pageY - c.offsetTop);
                    dragStart = ctx.transformedPoint(lastX, lastY);
                    dragged = false;
                }, false);

                canvas.addEventListener('mousemove', function (evt) {
                    lastX = evt.offsetX || (evt.pageX - c.offsetLeft);
                    lastY = evt.offsetY || (evt.pageY - c.offsetTop);
                    dragged = true;
                    if (dragStart) {
                        var pt = ctx.transformedPoint(lastX, lastY);
                        ctx.translate(pt.x - dragStart.x, pt.y - dragStart.y);
                        redraw();
                    }
                }, false);

                canvas.addEventListener('mouseup', function (evt) {
                    dragStart = null;
                    if (!dragged) zoom(evt.shiftKey ? -1 : 1);
                }, false);

                var scaleFactor = 1.1;

                var zoom = function (clicks) {
                    var pt = ctx.transformedPoint(lastX, lastY);
                    ctx.translate(pt.x, pt.y);
                    var factor = Math.pow(scaleFactor, clicks);
                    ctx.scale(factor, factor);
                    ctx.translate(-pt.x, -pt.y);
                    redraw();
                }

                var handleScroll = function (evt) {
                    var delta = evt.wheelDelta ? evt.wheelDelta / 40 : evt.detail ? -evt.detail : 0;
                    if (delta) zoom(delta);
                    return evt.preventDefault() && false;
                };

                canvas.addEventListener('DOMMouseScroll', handleScroll, false);
                canvas.addEventListener('mousewheel', handleScroll, false);
            };

            starter();

            // Adds ctx.getTransform() - returns an SVGMatrix
            // Adds ctx.transformedPoint(x,y) - returns an SVGPoint
            function trackTransforms(ctx) {
                var svg = document.createElementNS("http://www.w3.org/2000/svg", 'svg');
                var xform = svg.createSVGMatrix();
                ctx.getTransform = function () {
                    return xform;
                };

                var savedTransforms = [];
                var save = ctx.save;
                ctx.save = function () {
                    savedTransforms.push(xform.translate(0, 0));
                    return save.call(ctx);
                };

                var restore = ctx.restore;
                ctx.restore = function () {
                    xform = savedTransforms.pop();
                    return restore.call(ctx);
                };

                var scale = ctx.scale;
                ctx.scale = function (sx, sy) {
                    xform = xform.scaleNonUniform(sx, sy);
                    return scale.call(ctx, sx, sy);
                };

                var rotate = ctx.rotate;
                ctx.rotate = function (radians) {
                    xform = xform.rotate(radians * 180 / Math.PI);
                    return rotate.call(ctx, radians);
                };

                var translate = ctx.translate;
                ctx.translate = function (dx, dy) {
                    xform = xform.translate(dx, dy);
                    return translate.call(ctx, dx, dy);
                };

                var transform = ctx.transform;
                ctx.transform = function (a, b, c, d, e, f) {
                    var m2 = svg.createSVGMatrix();
                    m2.a = a;
                    m2.b = b;
                    m2.c = c;
                    m2.d = d;
                    m2.e = e;
                    m2.f = f;
                    xform = xform.multiply(m2);
                    return transform.call(ctx, a, b, c, d, e, f);
                };

                var setTransform = ctx.setTransform;
                ctx.setTransform = function (a, b, c, d, e, f) {
                    xform.a = a;
                    xform.b = b;
                    xform.c = c;
                    xform.d = d;
                    xform.e = e;
                    xform.f = f;
                    return setTransform.call(ctx, a, b, c, d, e, f);
                };

                var pt = svg.createSVGPoint();
                ctx.transformedPoint = function (x, y) {
                    pt.x = x;
                    pt.y = y;
                    return pt.matrixTransform(xform.inverse());
                }
            }
        }
        window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')
    </script>
    <script src="js/vendor/bootstrap.min.js"></script>

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
    <script>
        (function (b, o, i, l, e, r) {
            b.GoogleAnalyticsObject = l;
            b[l] || (b[l] = function () {
                (b[l].q = b[l].q || []).push(arguments)
            });
            b[l].l = +new Date;
            e = o.createElement(i);
            r = o.getElementsByTagName(i)[0];
            e.src = '//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e, r)
        }(window, document, 'script', 'ga'));
        ga('create', 'UA-XXXXX-X', 'auto');
        ga('send', 'pageview');
    </script>
</body>

</html>
