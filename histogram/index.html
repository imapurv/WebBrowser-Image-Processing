<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
    <script type="text/javascript" src="js/process.js" ></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
    <script type="text/javascript" src="js/process.js" ></script>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

    <script src="https://cdn.rawgit.com/seikichi/tiff.js/master/tiff.min.js"></script>

    <script src="https://cdn.rawgit.com/rfvallina/Misc/master/pdf.js"></script>

    <script type="text/javascript"><!--


    // --></script>
</head>

<body>
    <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <nav class="navbar navbar-default ">
        <div class="container bg-1">
            <div class="navbar-header bg-1"> <a class="navbar-brand" href="#">Histogram Image Density</a> </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="../index.html">Back</a></li>



                </ul>

            </div>
        </div>
    </nav>
    <div class="container text-right">
        <div class="container-fluid main">

            <label class="fileContainer right">
                <br>
                <button type="button" class="btn btn-default">Click here to Upload!</button>
                <input type="file" name="file" id="file" class="inputfile" data-multiple-caption="{count} files selected" multiple />
            </label>
            <div class="row">
                <div class="col-sm-6">

                        <h3 class="text-center">Viewer</h3>

                    <div id="maincontent">

                        <!--<div id="output" height="600px" width="200px" style="background-color: #8f231e;z-index: 14">asdfasdf</div> -->

                    </div>
                   <!-- <p><a><img
                        id="myImg" src="mushroom_kingdom.jpg" width="300" alt=""></a></p>-->


                </div>

                <div class="col-sm-6  ">
                    <div class="control">
                        <h3 class="text-center">Controls</h3>
                        <div class="tab-content">
                            <ul class="nav nav-tabs">
                                <li id="first" class="nav active"><a href="#A" onclick="changer(1)" data-toggle="tab">RGB Band</a></li>
                                <li class="nav"><a href="#A" onclick="changer(2)" data-toggle="tab">Red Band</a></li>

                                <li class="nav"><a href="#A" onclick="changer(4)" data-toggle="tab">Green Band</a></li>
                                <li class="nav"><a href="#A" onclick="changer(3)" data-toggle="tab">Blue Band</a></li>
                                <li class="nav"><a href="#E" data-toggle="tab">Option</a></li>
                            </ul>

                            <!-- Tab panes -->
                            <div class="tab-content text-center">

                                <div class="tab-pane fade in active" id="A"><canvas class="thumb" id="histogram" width="640" height="380">Your
                                    browser does not have support for Canvas.</canvas>

                                    <div id="range">

                                        <input type="range" id="myRangestart" class="center" value="0" min="0" max="255" onchange="updateTextInput(this.value);">
                                        <div class="row">
                                            <div class="col-sm-6 text-left" ><kbd>0</kbd> </div>
                                            <div class="col-sm-6 text-right"> <kbd>255</kbd>   </div>
                                        </div>
                                        <input type="range" id="myRangeend" class="center" value="255" min="0" max="255" onchange="updateTextInput(this.value);">
                                        <div class="row">
                                            <div class="col-sm-6 text-left" ><kbd>0</kbd> </div>
                                            <div class="col-sm-6 text-right"> <kbd>255</kbd>   </div>
                                        </div>

                                    </div>
                                    <ul id="cal">

                                    </ul>


                                    <p id="runtime">Plot runtime...</p></div>
                                <div class="tab-pane fade text-center" id="E">

                                    <form class="form-inline">




                                        <select id="histType" hidden>
                                            <option value="rgb">RGB</option>
                                            <option value="red">Red</option>
                                            <option value="green">Green</option>
                                            <option value="blue">Blue</option>
                                            <option value="hue">Hue</option>
                                            <option value="sat">Saturation</option>
                                            <option value="val">Value (brightness)</option>
                                            <option value="cmyk">CMYK</option>
                                            <option value="cyan">Cyan</option>
                                            <option value="magenta">Magenta</option>
                                            <option value="yellow">Yellow</option>
                                            <option value="kelvin">Kelvin (Black)</option>
                                        </select>

                                       <br>

                                    <div class="form-group">
                                        <p><label>Count every <input class="form-control" id="accuracy" type="number" min="1" max="50"
                                                                     value="1"> pixels</label></p>
                                    </div>
                                        <hr>
                                    <p><label>Plot style: <select class="form-control" id="plotStyle">
                                        <option value="continuous">Continuous</option>
                                        <option value="discreet">Discreet</option>
                                    </select></label></p>
                                        <hr>
                                    <p><label>Plot fill <input class="form-control" id="plotFill" type="checkbox"></label></p>
                                        <hr>
                                    <p><label>Plot colors: <select id="plotColors" class="form-control">
                                        <option value="flat">Flat colors</option>
                                        <option value="none">None</option>

                                        <option value="gradient">Gradients</option>
                                    </select></label></p>
                                    </form>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <br>
    <hr>
    <div class="row"> <span class="center-block text-center">Done Editing? <a href="#" id="down" class="btn btn-success" role="button">Download Image</a></span> </div>
    <br>
        <footer class="text-center navbar navbar-default ">

        </footer>
    <!-- /container -->
        <script>

        </script>
    <script>
        document.getElementById('down').addEventListener('click', function() {
            downloadCanvas(this, 'c', 'test.png');
        }, false);
        function downloadCanvas(link, canvasId, filename) {

            link.href = document.getElementById(canvasId).toDataURL();
            link.download = filename;
        }
        function calmean(pixel, n, m) {
            "use strict";
            var i, j, mean = 0;
            for (i = 0; i < n; i += 1) {
                for (j = 0; j < m; j += 1) {
                    mean += pixel[i][j];
                }
            }
            mean = mean / (n * m);
            return mean;
        }

        function calvariance(pixel, n, m) {
            "use strict";
            var i, j, variance, sum = 0, mean = calmean(pixel, n, m);
            for (i = 0; i < n; i += 1) {
                for (j = 0; j < m; j += 1) {
                    sum += Math.pow(mean - pixel[i][j]);
                }
            }
            variance = sum / ((n * m) - 1);
            return variance;
        }

        function calstddevi(pixel, n, m) {
            "use strict";
            var stddevi = Math.sqrt(calvariance(pixel, n, m));
            return stddevi;
        }
        document.getElementById('maincontent').innerHTML += "<canvas style=\"z-index: -10;\" id=\"c\" ></canvas> ";
        var ctx = c.getContext("2d");

        var k=0;
        var original;
        var stack = [];
        newImage("http://i.imgur.com/OrYVGI8.jpg");


        $("#file").change(function(evt){
            var parentEl = $("#maincontent");

            console.debug("Event image...");
            var tgt = evt.target || window.event.srcElement,
                files = tgt.files;
            var extensions = files[0].name.split('.').pop().toLowerCase();
            console.debug(extensions);
            if (extensions != "tiff" && extensions != "tif"){
                var URL = window.webkitURL || window.URL;
                var url = URL.createObjectURL(evt.target.files[0]);
                newImage(url);
                histType.value="rgb";
                updateHist("rgb");

            }
            else {// FileReader support
                var fileTypes = ['jpg', 'jpeg', 'png', 'tiff', 'tif', 'pdf']; //acceptable file types
                parentEl.find("canvas").remove();
                if (FileReader && files && files.length) {
                    var fr = new FileReader();
                    var extension = files[0].name.split('.').pop().toLowerCase();
                    var tif = false;
                    var pdf = false;
                    if (extension == "tiff" || extension == "tif")
                        tif = true;
                    else if (extension == "pdf")
                        pdf = true;
                    fr.onload = function(e) {
                        success = fileTypes.indexOf(extension) > -1;
                        if (success) {
                            if (tif) {
                                //Using tiff.min.js library - https://github.com/seikichi/tiff.js/tree/master
                                console.debug("Parsing TIFF image...");
                                //initialize with 100MB for large files
                                Tiff.initialize({
                                    TOTAL_MEMORY: 100000000
                                });
                                var tiff = new Tiff({
                                    buffer: e.target.result
                                });
                                var tiffCanvas = tiff.toCanvas();
                                $(tiffCanvas).css({

                                    "z-index":"-10",
                                    "max-width" :"100%",
                                    "max-height" :"100%"
                                }).addClass("ui-draggable ui-draggable-handle");
                                tiffCanvas.id="c";
                                console.debug("converted");
                                $(parentEl).append(tiffCanvas);
                                ctx=tiffCanvas.getContext("2d");
                                runner(ctx);
                            } else if (pdf) {

                            } else {
                                console.debug("render immmm");
                                $(parentEl).append('<img src="' + fr.result + '" class="preview"/>');
                            }
                        }

                    }

                    fr.onloadend = function(e) {
                        console.debug("Load End");
                    }
                    if (tif)
                        fr.readAsArrayBuffer(files[0]);

                }
            }
        });

        var acc = document.getElementsByClassName("accordion");
        var i;

        for (i = 0; i < acc.length; i++) {
            acc[i].onclick = function(){
                this.classList.toggle("active");
                this.nextElementSibling.classList.toggle("show");
            }
        }


        var histCanvas = document.getElementById('histogram'),
            histCtx = histCanvas.getContext('2d'),
            histType = document.getElementById('histType'),
            accuracy = document.getElementById('accuracy'),

            plotStyle = document.getElementById('plotStyle'),
            calc = document.getElementById('cal'),
            plotFill = document.getElementById('plotFill'),
            plotColors = document.getElementById('plotColors'),
            imgSelector = document.getElementById('imgSelector'),
            gradients = {
                'red':     histCtx.createLinearGradient(0, 0, 500, 0),
                'green':   histCtx.createLinearGradient(0, 0, 500, 0),
                'blue':    histCtx.createLinearGradient(0, 0, 500, 0),
                'hue':     histCtx.createLinearGradient(0, 0, 500, 0),
                'val':     histCtx.createLinearGradient(0, 0, 500, 0),
                'cyan':    histCtx.createLinearGradient(0, 0, 500, 0),
                'magenta': histCtx.createLinearGradient(0, 0, 500, 0),
                'yellow':  histCtx.createLinearGradient(0, 0, 500, 0),
                'kelvin':  histCtx.createLinearGradient(0, 0, 500, 0)
            },

            imgCtx = ctx,
            colors = {
                'red':   ['#000', '#f00'],
                'green': ['#000', '#0f0'],
                'blue':  ['#000', '#00f'],
                'hue':   [
                    '#f00',   // 0, Red,       0°
                    '#ff0',   // 1, Yellow,   60°
                    '#0f0',   // 2, Green,   120°
                    '#0ff',   // 3, Cyan,    180°
                    '#00f',   // 4, Blue,    240°
                    '#f0f',   // 5, Magenta, 300°
                    '#f00'],  // 6, Red,     360°
                'val':     ['#000', '#fff'],
                'kelvin':  ['#fff', '#000'],
                'cyan':    ['#000', '#0ff'],
                'yellow':  ['#000', '#ff0'],
                'magenta': ['#000', '#f0f']
            },
            discreetWidth = Math.round(histCanvas.width / 255),
            imgData = null;
        var initHistogram = function () {
            // Plot defaults
            accuracy.value = 1;
            plotStyle.value = 'continuous';
            plotColors.value = 'flat';
            plotFill.checked = true;


            console.log(imgData);
            var grad, color, i, n;
            for (grad in gradients) {
                color = colors[grad];
                grad = gradients[grad];

                for (i = 0, n = color.length; i < n; i++) {
                    grad.addColorStop(i*1/(n-1), color[i]);
                }
            }

        };
        var imgLoaded = function (t) {
            imgData = original.data;

            histType.value = t;

            //updateHist();
        };

        var calcHist = function (type) {
            var mean; var redavg=0,blueavg=0,greenavg=0; var tt=0;
            var chans = [[]],
                maxCount = 0, val, subtypes = [type];

            if (type === 'rgb') {
                chans = [[], [], []];
                subtypes = ['red', 'green', 'blue'];
            }

            var step = parseInt(accuracy.value);
            if (isNaN(step) || step < 1) {
                step = 1;
            } else if (step > 50) {
                step = 50;
            }
            accuracy.value = step;
            step *= 4;

            for (var i = 0, n = imgData.length; i < n; i+= step) {
                if (type === 'rgb' || type === 'red' || type === 'green' || type ===
                    'blue') {
                    val = [imgData[i], imgData[i+1], imgData[i+2]];

                }
                if(type==='rgb'){
                    redavg+=imgData[i];
                    blueavg+=imgData[i+1];
                    greenavg+=imgData[i+2];
                }
                else if(type ==='red'){
                    redavg+=imgData[i];
                }
                else if(type==='green'){
                    blueavg+=imgData[i+1];
                }
                else if(type==='blue'){
                    greenavg+=imgData[i+2];
                }

                if (type === 'red' || type === 'hue' || type === 'cyan') {

                    val = [val[0]];

                } else if (type === 'green' || type === 'sat' || type === 'magenta') {

                    val = [val[1]];

                } else if (type === 'blue' || type === 'val' || type === 'yellow') {

                    val = [val[2]];

                } else if (type === 'kelvin') {
                    val = [val[3]];
                }

                for (var y = 0, m = val.length; y < m; y++) {
                    if (val[y] in chans[y]) {
                        chans[y][val[y]]++;
                    } else {
                        chans[y][val[y]] = 1;
                    }

                    if (chans[y][val[y]] > maxCount) {
                        maxCount = chans[y][val[y]];
                    }
                }
            }


            tt=redavg+blueavg+greenavg;
            var pix=imgData.length/4;
            tt=tt/pix;
            /*for (var i = 0, n = imgData.length; i < n; i+= step) {
                if (type === 'rgb') {
                    redavg += imgData[i];
                    blueavg += imgData[i + 1];
                    greenavg += imgData[i + 2];
                }
                else if (type === 'red') {
                    redavg += imgData[i];
                }
                else if (type === 'green') {
                    blueavg += imgData[i + 1];
                }
                else if (type === 'blue') {
                    greenavg += imgData[i + 2];
                }
            }*/
            if(type==='rgb'){
                tt=tt/3;
                $("#range").hide();

            }
            else{
                $("#range").show();
            }
            tt=tt.toFixed(2);
            document.getElementById("cal").innerHTML="";
           // document.getElementById("cal").removeChild("All")
            var node = document.createElement("LI");
            var textnode = document.createTextNode("Mean : "+tt);
            var textnode1 = document.createTextNode("Pixels : "+pix);
            var textnode2 = document.createTextNode("RGB Avg : "+redavg+" | "+greenavg+" | "+blueavg);
            node.appendChild(textnode);
            document.getElementById("cal").appendChild(node);
            node = document.createElement("LI");
            node.appendChild(textnode1);
            document.getElementById("cal").appendChild(node);
            node = document.createElement("LI");
            node.appendChild(textnode2);
            document.getElementById("cal").appendChild(node);
          //  calc.innerHTML = 'Mean : '+tt+" \n Red :"+redavg+" Blue:"+blueavg+" Green: "+greenavg+" Pixels : "+imgData.length/4;
            console.log(tt+" "+tt/imgData.length/4+" "+imgData.length/4);
            if (maxCount === 0) {
                return;
            }

            histCtx.clearRect(0, 0, histCanvas.width, histCanvas.height);

            if (plotFill.checked && chans.length > 1) {
                histCtx.globalCompositeOperation = 'lighter';
            }

            for (var i = 0, n = chans.length; i < n; i++) {
                drawHist(subtypes[i], chans[i], maxCount);
            }

            if (plotFill.checked && chans.length > 1) {
                histCtx.globalCompositeOperation = 'source-over';
            }
        };
        var drawHist = function (type, vals, maxCount) {
            var ctxStyle;

            if (plotFill.checked || plotStyle.value === 'discreet') {
                ctxStyle = 'fillStyle';
                histCtx.strokeStyle = '#000';
            } else {
                ctxStyle = 'strokeStyle';
            }

            if (plotColors.value === 'flat') {
                if (type === 'hue') {
                    histCtx[ctxStyle] = gradients.hue;
                } else if (type in colors && type !== 'val') {
                    histCtx[ctxStyle] = colors[type][1];
                } else {
                    histCtx[ctxStyle] = '#000';
                }

            } else if (plotColors.value === 'gradient') {
                if (type in gradients) {
                    histCtx[ctxStyle] = gradients[type];
                } else {
                    histCtx[ctxStyle] = '#000';
                }
            } else if (plotColors.value === 'none') {
                histCtx[ctxStyle] = '#000';
            }

            if (plotStyle.value === 'continuous') {
                histCtx.beginPath();
                histCtx.moveTo(0, histCanvas.height);
            }
            var last; var first; var flag=0;
            for (var x, y, i = 0; i <= 255; i++) {
                if (!(i in vals)) {
                    continue;
                }
                if(flag==0){
                    first=i;
                    flag=1;
                }
                last=i;

                y = Math.round((vals[i]/maxCount)*histCanvas.height);
                x = Math.round((i/255)*histCanvas.width);

                if (plotStyle.value === 'continuous') {
                    histCtx.lineTo(x, histCanvas.height - y);
                } else if (plotStyle.value === 'discreet') {
                    if (plotFill.checked) {
                        histCtx.fillRect(x, histCanvas.height - y, discreetWidth, y);
                    } else {
                        histCtx.fillRect(x, histCanvas.height - y, discreetWidth, 2);
                    }
                }
            }
         /*   var median=(first+last)/2;
            var node = document.createElement("LI");
            var textnode = document.createTextNode("Median : "+median);
            node.appendChild(textnode);
            document.getElementById("cal").appendChild(node);*/

            if (plotStyle.value === 'continuous') {
                histCtx.lineTo(x, histCanvas.height);
                if (plotFill.checked) {
                    histCtx.fill();
                }
                histCtx.stroke();
                histCtx.closePath();
            }
        };
        var updateHist = function (tmp) {
           // initHistogram(tmp);
            imgLoaded(tmp);
            var timeStart = (new Date()).getTime();

            runtime.innerHTML = 'Calculating histogram...';

            calcHist(tmp);
            console.log("Here "+histType.value);
            var timeEnd = (new Date()).getTime();
            runtime.innerHTML = 'Plot runtime: ' + (timeEnd - timeStart) + ' ms.';
        };
        var updateHists = function () {
            var timeStart = (new Date()).getTime();

            runtime.innerHTML = 'Calculating histogram...';

            calcHist(histType.value);

            var timeEnd = (new Date()).getTime();
            runtime.innerHTML = 'Plot runtime: ' + (timeEnd - timeStart) + ' ms.';
        };

        function calcu() {
            imgData = original.data;
            var mean; var redavg=0,blueavg=0,greenavg=0;
            var step=4;
            for (var i = 0, n = imgData.length; i < n; i+= step) {
                if (type === 'rgb' || type === 'red' || type === 'green' || type ===
                    'blue') {
                    val = [imgData[i], imgData[i + 1], imgData[i + 2]];
                    redavg+=val[0];
                    blueavg+=val[1];
                }
            }
        }
        plotStyle.addEventListener('change', updateHists, false);
        plotFill.addEventListener('change', updateHists, false);
        plotColors.addEventListener('change', updateHists, false);
        accuracy.addEventListener('change', updateHists, false);
        function changer(t){
            if(t==1){
                histType.value="rgb";
                updateHist("rgb");
            }
            if(t==2){
                histType.value="red";
                updateHist("red");
                // histo.
            }
            else if(t==3){
                histType.value="blue";
                updateHist("blue");
                // histo.updateHist();
            }
            else if(t==4){
                histType.value="green";
                updateHist("green");

            }
        }window.onload = function() {
            histType.value="rgb";
            updateHist("rgb");
        };

        window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')
    </script>
    <script src="js/vendor/bootstrap.min.js"></script>

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
    <script>
        (function (b, o, i, l, e, r) {
            b.GoogleAnalyticsObject = l;
            b[l] || (b[l] = function () {
                (b[l].q = b[l].q || []).push(arguments)
            });
            b[l].l = +new Date;
            e = o.createElement(i);
            r = o.getElementsByTagName(i)[0];
            e.src = '//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e, r)
        }(window, document, 'script', 'ga'));
        ga('create', 'UA-XXXXX-X', 'auto');
        ga('send', 'pageview');
    </script>
</body>

</html>
